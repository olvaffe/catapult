<!DOCTYPE html>
<!--
Copyright (c) 2018 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<link rel="import" href="/tracing/core/test_utils.html">
<link rel="import" href="/tracing/extras/importer/linux_perf/ftrace_importer.html">

<script>
'use strict';

tr.b.unittest.testSuite(function() {
  test('virtioGpuEventImport', function() {
    const lines = [
      '       test-3268  ( 3214) [010] ....   505.065364: virtio_gpu_cmd_queue: vdev=0 vq=0 name=control type=0x207 flags=0x1 fence_id=109780 ctx_id=8', // @suppress longLineCheck
      'kworker/2:1-109   (  109) [002] ....   505.075414: virtio_gpu_cmd_response: vdev=0 vq=0 name=control type=0x1100 flags=0x1 fence_id=109780 ctx_id=8', // @suppress longLineCheck
    ];

    const m = tr.c.TestUtils.newModelWithEvents([lines.join('\n')], {
      shiftWorldToZero: false
    });
    assert.isFalse(m.hasImportWarnings);

    let threads = m.getAllThreads();
    assert.strictEqual(threads.length, 2);

    threads = m.findAllThreadsNamed('control-vq');
    assert.strictEqual(threads.length, 1);
    assert.strictEqual(threads[0].sliceGroup.length, 1);
    assert.strictEqual('cmd(8,109780)',
        threads[0].sliceGroup.slices[0].title);

    threads = m.findAllThreadsNamed('control-resp');
    assert.strictEqual(threads.length, 1);
    assert.strictEqual(threads[0].sliceGroup.length, 1);
    assert.strictEqual('cmd(8,109780)',
        threads[0].sliceGroup.slices[0].title);
  });
});
</script>

